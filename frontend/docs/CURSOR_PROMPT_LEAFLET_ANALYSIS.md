# Промпт для Cursor: Анализ проблемы отображения карты Leaflet

## Промпт

```
Проанализируй проблему: карта Leaflet не отображается на странице /routes/details.

Выполни самостоятельный анализ:

1. Определи, какой провайдер карты реально выбирается на странице:
   - Проверь RouteDetailsView → RouteMapWithAlternatives → RouteMapSwitcher → RouteMap
   - Найди, передаётся ли providerType='leaflet' или используется дефолтный 'yandex'
   - Проверь все дефолтные значения providerType в цепочке компонентов

2. Проверь загрузку CSS Leaflet:
   - Найди useEffect, который загружает Leaflet CSS
   - Определи, при каких условиях CSS загружается
   - Проверь, выполняется ли условие providerType === 'leaflet'

3. Проверь создание экземпляра LeafletMapProvider:
   - Найди useMemo, который создаёт провайдер
   - Определи, создаётся ли LeafletMapProvider или YandexMapProvider
   - Проверь зависимости useMemo

4. Проверь инициализацию карты:
   - Найди useEffect, который вызывает initialize()
   - Определи, вызывается ли initialize() для Leaflet
   - Проверь, становится ли isMapReady = true после инициализации
   - Проверь обработку ошибок инициализации

5. Проанализируй race condition:
   - Найди useEffect для рендеринга полилиний (addPolyline)
   - Найди useEffect для рендеринга маркеров (addMarker)
   - Определи, могут ли они выполниться ДО того, как mapProviderRef.current установлен
   - Проверь, есть ли проверка isInitialized() или isMapReady перед вызовами

6. Проверь зависимости useEffect:
   - Определи порядок выполнения эффектов
   - Проверь, не срабатывают ли эффекты слишком рано
   - Проверь, не блокируются ли эффекты условиями

7. Проверь контейнер карты:
   - Найди ref контейнера (containerRef)
   - Проверь, имеет ли контейнер размеры в момент инициализации
   - Проверь логику checkContainerSize()

Сформируй итоговый отчёт:

КОРНЕВАЯ ПРИЧИНА:
- Что именно мешает карте отображаться
- Какая первая проблема в цепочке

МЕСТО ОШИБКИ:
- Файл и строка, где находится проблема
- Какой компонент/эффект/функция

ПРОБЛЕМЫ С ЭФФЕКТАМИ:
- Какие useEffect срабатывают слишком рано
- Какие useEffect не срабатывают вообще
- Какие зависимости вызывают лишние перерендеры

ЧТО МЕШАЕТ LEAFLET СТАРТОВАТЬ:
- providerType не передаётся / передаётся неправильно
- CSS не загружается
- Провайдер не создаётся
- initialize() не вызывается
- Контейнер не имеет размеров
- Race condition между инициализацией и рендерингом
- mapProviderRef.current = null в момент вызова addPolyline/addMarker
- Другие проблемы

СПИСОК ТОЧЕЧНЫХ ИСПРАВЛЕНИЙ:
- Файл, строка, что нужно исправить
- Конкретное действие (добавить проверку, изменить условие, добавить зависимость и т.д.)
- Приоритет (критический/высокий/средний)

Не пиши код — только анализ и список исправлений.
```



