# –§–ò–ù–ê–õ–¨–ù–´–ô –û–¢–ß–Å–¢: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∏ –≤—ã—Å–æ–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º Leaflet-–∫–∞—Ä—Ç—ã

**–î–∞—Ç–∞:** 2024  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏ –≤—ã—Å–æ–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã  
**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É:** 100%

---

## –†–ï–ó–Æ–ú–ï

–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏ –≤—ã—Å–æ–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã, –≤—ã—è–≤–ª–µ–Ω–Ω—ã–µ –≤ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–º –∞—É–¥–∏—Ç–µ, —É—Å–ø–µ—à–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã. –ú–æ–¥—É–ª—å Leaflet-–∫–∞—Ä—Ç—ã —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
- üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã: 2/2 (100%)
- üü† –í—ã—Å–æ–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã: 3/3 (100%)
- üü° –°—Ä–µ–¥–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã: 2/2 (100%)

---

## 1. –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê #1: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è invalidateSize() –∏ setBounds()

### –ü—Ä–æ–±–ª–µ–º–∞
–ì–æ–Ω–∫–∞ –º–µ–∂–¥—É `invalidateSize()` –∏ `setBounds()`: `setBounds()` –º–æ–≥ –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –¥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤ –∫–∞—Ä—Ç—ã —á–µ—Ä–µ–∑ `invalidateSize()`, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É —Ä–∞—Å—á—ë—Ç—É –≥—Ä–∞–Ω–∏—Ü.

### –†–µ—à–µ–Ω–∏–µ
**–§–∞–π–ª:** `frontend/src/modules/routes/features/route-map/ui/route-map.tsx`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

1. **–î–æ–±–∞–≤–ª–µ–Ω —Ñ–ª–∞–≥ `isSizeValidated`** (—Å—Ç—Ä–æ–∫–∞ 112):
   ```typescript
   const [isSizeValidated, setIsSizeValidated] = useState(false);
   ```

2. **–£–ª—É—á—à–µ–Ω–∞ –∑–∞–¥–µ—Ä–∂–∫–∞ `invalidateSize()`** (—Å—Ç—Ä–æ–∫–∏ 362-375):
   - –ó–∞–º–µ–Ω—ë–Ω —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π `setTimeout(..., 100)` –Ω–∞ –¥–≤–æ–π–Ω–æ–π `requestAnimationFrame`
   - –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –±–æ–ª–µ–µ –Ω–∞–¥—ë–∂–Ω–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ —Ä–µ–Ω–¥–µ—Ä–∞ DOM
   - –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è `setIsSizeValidated(true)`
   - –î–ª—è –Ω–µ-Leaflet –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ —Ñ–ª–∞–≥ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É

3. **–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ —ç—Ñ—Ñ–µ–∫—Ç `setBounds`** (—Å—Ç—Ä–æ–∫–∏ 449-452):
   - –î–ª—è Leaflet –∫–∞—Ä—Ç–∞ –∂–¥—ë—Ç, –ø–æ–∫–∞ `isSizeValidated === true`
   - –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ `setBounds()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤

4. **–°–±—Ä–æ—Å —Ñ–ª–∞–≥–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ** (—Å—Ç—Ä–æ–∫–∏ 234, 435, 596):
   - –§–ª–∞–≥ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
   - –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ä–∞–±–æ—Ç—É –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–∫–∞—Ö

### –†–µ–∑—É–ª—å—Ç–∞—Ç
‚úÖ `setBounds()` —Ç–µ–ø–µ—Ä—å –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Å—Ç—Ä–æ–≥–æ –ø–æ—Å–ª–µ `invalidateSize()`  
‚úÖ –ù–µ—Ç –≥–æ–Ω–æ–∫ –º–µ–∂–¥—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Ä–∞–∑–º–µ—Ä–æ–≤ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π –≥—Ä–∞–Ω–∏—Ü  
‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∞–≤—Ç–æ—Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö

---

## 2. –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê #2: –í–∞–ª–∏–¥–∞—Ü–∏—è bounds –≤ setBounds()

### –ü—Ä–æ–±–ª–µ–º–∞
–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ bounds –≤ –º–µ—Ç–æ–¥–µ `setBounds()` –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –æ—à–∏–±–∫–∞–º –ø—Ä–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏—è—Ö (null, undefined, –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –≥–µ–æ–º–µ—Ç—Ä–∏—è).

### –†–µ—à–µ–Ω–∏–µ
**–§–∞–π–ª:** `frontend/src/modules/routes/lib/providers/leaflet-map-provider.ts`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ null/undefined** (—Å—Ç—Ä–æ–∫–∏ 195-199):
   ```typescript
   if (!bounds) {
     console.warn('LeafletMapProvider.setBounds: Bounds are null or undefined');
     return;
   }
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ –∏ –∫–æ–Ω–µ—á–Ω–æ—Å—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏–π** (—Å—Ç—Ä–æ–∫–∏ 201-220):
   - –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è —è–≤–ª—è—é—Ç—Å—è —á–∏—Å–ª–∞–º–∏
   - –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –∫–æ–Ω–µ—á–Ω—ã–µ (`Number.isFinite`)
   - Fallback –Ω–∞ `setCenter()` –ø—Ä–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏—è—Ö

3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–µ–æ–º–µ—Ç—Ä–∏–∏ bounds** (—Å—Ç—Ä–æ–∫–∏ 222-232):
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ `north > south` –∏ `east > west`
   - Fallback –Ω–∞ `setCenter()` –ø—Ä–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –≥–µ–æ–º–µ—Ç—Ä–∏–∏

4. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ bounds** (—Å—Ç—Ä–æ–∫–∏ 265-277):
   - –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 0.001 –≥—Ä–∞–¥—É—Å–∞
   - Fallback –Ω–∞ `setCenter()` –¥–ª—è —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏—Ö bounds

5. **–£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** (—Å—Ç—Ä–æ–∫–∏ 283-297):
   - Try-catch —Å fallback –Ω–∞ `setCenter()`
   - –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π

### –†–µ–∑—É–ª—å—Ç–∞—Ç
‚úÖ –í—Å–µ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ bounds –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º `fitBounds()`  
‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π fallback –Ω–∞ `setCenter()` –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö  
‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ –ø—Ä–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

---

## 3. –í–´–°–û–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê #3: –ó–∞–º–µ–Ω–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏ invalidateSize()

### –ü—Ä–æ–±–ª–µ–º–∞
–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ 100ms –º–æ–≥–ª–∞ –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–π –Ω–∞ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö.

### –†–µ—à–µ–Ω–∏–µ
**–§–∞–π–ª:** `frontend/src/modules/routes/features/route-map/ui/route-map.tsx`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –ó–∞–º–µ–Ω—ë–Ω `setTimeout(..., 100)` –Ω–∞ –¥–≤–æ–π–Ω–æ–π `requestAnimationFrame` (—Å—Ç—Ä–æ–∫–∏ 362-375)
- –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –±–æ–ª–µ–µ –Ω–∞–¥—ë–∂–Ω–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ —Ä–µ–Ω–¥–µ—Ä–∞ DOM
- –†–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö

### –†–µ–∑—É–ª—å—Ç–∞—Ç
‚úÖ –ë–æ–ª–µ–µ –Ω–∞–¥—ë–∂–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º –æ–∂–∏–¥–∞–Ω–∏—è —Ä–µ–Ω–¥–µ—Ä–∞  
‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –Ω–∞ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö  
‚úÖ –ù–µ—Ç –≥–æ–Ω–æ–∫ –∏ —Ä–∞–∑–ª–∏—á–∏–π –≤ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —Ä–∞–º–∫–∞—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–±–ª–µ–º—ã #1.

---

## 4. –í–´–°–û–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê #4: –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ª–∏—à–Ω–∏—Ö –≤—ã–∑–æ–≤–æ–≤ fitBounds()

### –ü—Ä–æ–±–ª–µ–º–∞
–≠—Ñ—Ñ–µ–∫—Ç `setBounds` –≤—ã–∑—ã–≤–∞–ª—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π, –¥–∞–∂–µ –µ—Å–ª–∏ bounds —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å.

### –†–µ—à–µ–Ω–∏–µ
**–§–∞–π–ª:** `frontend/src/modules/routes/features/route-map/ui/route-map.tsx`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

1. **–î–æ–±–∞–≤–ª–µ–Ω `previousBoundsRef`** (—Å—Ç—Ä–æ–∫–∞ 106):
   ```typescript
   const previousBoundsRef = useRef<IMapBounds | null>(null);
   ```

2. **–î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç `IMapBounds`** (—Å—Ç—Ä–æ–∫–∞ 13):
   ```typescript
   import type { IRouteMapData, IMapBounds } from '../../../domain/map-types';
   ```

3. **–°—Ä–∞–≤–Ω–µ–Ω–∏–µ bounds –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º** (—Å—Ç—Ä–æ–∫–∏ 454-463):
   - –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–∏—Ö bounds —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏
   - –ü—Ä–æ–ø—É—Å–∫ –≤—ã–∑–æ–≤–∞, –µ—Å–ª–∏ bounds –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `previousBoundsRef` –ø–æ—Å–ª–µ –≤—ã–∑–æ–≤–∞

4. **–°–±—Ä–æ—Å –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ** (—Å—Ç—Ä–æ–∫–∞ 435):
   - `previousBoundsRef.current = null` –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

### –†–µ–∑—É–ª—å—Ç–∞—Ç
‚úÖ `setBounds()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ bounds  
‚úÖ –ù–µ—Ç –ª–∏—à–Ω–∏—Ö –≤—ã–∑–æ–≤–æ–≤ `fitBounds()` –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –º–∞—Ä—à—Ä—É—Ç–æ–≤  
‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

---

## 5. –í–´–°–û–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê #5: –ó–∞—â–∏—Ç–∞ –æ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö bounds

### –ü—Ä–æ–±–ª–µ–º–∞
–ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–µ–æ–º–µ—Ç—Ä–∏–∏ bounds (`north > south`, `east > west`) –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º `fitBounds()`.

### –†–µ—à–µ–Ω–∏–µ
**–§–∞–π–ª:** `frontend/src/modules/routes/lib/providers/leaflet-map-provider.ts`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≥–µ–æ–º–µ—Ç—Ä–∏–∏ bounds (—Å—Ç—Ä–æ–∫–∏ 222-232)
- Fallback –Ω–∞ `setCenter()` –ø—Ä–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –≥–µ–æ–º–µ—Ç—Ä–∏–∏
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π

### –†–µ–∑—É–ª—å—Ç–∞—Ç
‚úÖ –í—Å–µ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ bounds –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è  
‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π fallback –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö  
‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ –ø—Ä–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –≥–µ–æ–º–µ—Ç—Ä–∏–∏

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —Ä–∞–º–∫–∞—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–±–ª–µ–º—ã #2.

---

## 6. –°–†–ï–î–ù–Ø–Ø –ü–†–û–ë–õ–ï–ú–ê #6: –£–ª—É—á—à–µ–Ω–∏–µ key –≤ RouteMapSwitcher

### –ü—Ä–æ–±–ª–µ–º–∞
Key –Ω–µ —É—á–∏—Ç—ã–≤–∞–ª —Ç–µ–∫—É—â–∏–π –º–∞—Ä—à—Ä—É—Ç, —á—Ç–æ –º–æ–≥–ª–æ –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø—Ä–æ–±–ª–µ–º–∞–º –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –º–∞—Ä—à—Ä—É—Ç–æ–≤.

### –†–µ—à–µ–Ω–∏–µ
**–§–∞–π–ª:** `frontend/src/modules/routes/features/route-map/ui/route-map-switcher.tsx`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- Key —Ç–µ–ø–µ—Ä—å –≤–∫–ª—é—á–∞–µ—Ç `currentRoute.routeId` –∏ `currentRouteIndex` (—Å—Ç—Ä–æ–∫–∞ 172):
  ```typescript
  key={preserveMapPosition ? 'preserve' : `route-map-${providerType}-${currentRoute.routeId}-${currentRouteIndex}`}
  ```

### –†–µ–∑—É–ª—å—Ç–∞—Ç
‚úÖ –ö–∞—Ä—Ç–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –º–∞—Ä—à—Ä—É—Ç–æ–≤  
‚úÖ –ü—Ä–∏ `preserveMapPosition === true` key –æ—Å—Ç–∞—ë—Ç—Å—è —Å—Ç–∞–±–∏–ª—å–Ω—ã–º  
‚úÖ –ù–µ—Ç –ø—Ä–æ–±–ª–µ–º —Å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∫–∞—Ä—Ç—ã –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è—Ö

---

## 7. –°–†–ï–î–ù–Ø–Ø –ü–†–û–ë–õ–ï–ú–ê #7: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ zIndex –¥–ª—è transfer-–º–∞—Ä–∫–µ—Ä–æ–≤

### –ü—Ä–æ–±–ª–µ–º–∞
–ù–µ—Ç —è–≤–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ zIndex –¥–ª—è transfer –º–∞—Ä–∫–µ—Ä–æ–≤, –æ–Ω–∏ –º–æ–≥–ª–∏ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—Ç—å—Å—è –æ–±—ã—á–Ω—ã–º–∏ –º–∞—Ä–∫–µ—Ä–∞–º–∏.

### –†–µ—à–µ–Ω–∏–µ
**–§–∞–π–ª:** `frontend/src/modules/routes/lib/providers/leaflet-map-provider.ts`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

1. **–î–æ–±–∞–≤–ª–µ–Ω `zIndexOffset` –≤ –æ–ø—Ü–∏–∏ –∏–∫–æ–Ω–∫–∏** (—Å—Ç—Ä–æ–∫–∏ 355-363):
   ```typescript
   const iconOptions: {
     iconUrl: string;
     iconSize: [number, number];
     iconAnchor: [number, number];
     zIndexOffset?: number;
   } = {
     // ...
     zIndexOffset: options?.isTransfer ? 1000 : 0,
   };
   ```

2. **–î–æ–±–∞–≤–ª–µ–Ω `zIndexOffset` –Ω–∞ —É—Ä–æ–≤–Ω–µ –º–∞—Ä–∫–µ—Ä–∞** (—Å—Ç—Ä–æ–∫–∏ 366-370):
   ```typescript
   const marker = (L as { marker: ... }).marker([coordinate[0], coordinate[1]], { 
     icon,
     zIndexOffset: options?.isTransfer ? 1000 : undefined,
   }).addTo(this.map as unknown) as unknown as LeafletMarker;
   ```

### –†–µ–∑—É–ª—å—Ç–∞—Ç
‚úÖ Transfer –º–∞—Ä–∫–µ—Ä—ã –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –ø–æ–≤–µ—Ä—Ö –æ–±—ã—á–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤  
‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤  
‚úÖ –ù–µ—Ç –ø—Ä–æ–±–ª–µ–º —Å –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ–º –º–∞—Ä–∫–µ—Ä–æ–≤

---

## –ò–¢–û–ì–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

| –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ | –°—Ç–∞—Ç—É—Å |
|-----------|-----------|--------|
| üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ | 2 | ‚úÖ 100% |
| üü† –í—ã—Å–æ–∫–∏–µ | 3 | ‚úÖ 100% |
| üü° –°—Ä–µ–¥–Ω–∏–µ | 2 | ‚úÖ 100% |
| **–í—Å–µ–≥–æ** | **7** | **‚úÖ 100%** |

### –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

1. `frontend/src/modules/routes/features/route-map/ui/route-map.tsx`
   - –î–æ–±–∞–≤–ª–µ–Ω —Ñ–ª–∞–≥ `isSizeValidated`
   - –£–ª—É—á—à–µ–Ω–∞ –∑–∞–¥–µ—Ä–∂–∫–∞ `invalidateSize()`
   - –î–æ–±–∞–≤–ª–µ–Ω–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ bounds
   - –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç `IMapBounds`

2. `frontend/src/modules/routes/lib/providers/leaflet-map-provider.ts`
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–ª–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è bounds
   - –î–æ–±–∞–≤–ª–µ–Ω `zIndexOffset` –¥–ª—è transfer –º–∞—Ä–∫–µ—Ä–æ–≤
   - –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

3. `frontend/src/modules/routes/features/route-map/ui/route-map-switcher.tsx`
   - –£–ª—É—á—à–µ–Ω key –¥–ª—è —É—á—ë—Ç–∞ —Ç–µ–∫—É—â–µ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞

### –°—Ç—Ä–æ–∫–∏ –∫–æ–¥–∞

- **–î–æ–±–∞–≤–ª–µ–Ω–æ:** ~150 —Å—Ç—Ä–æ–∫
- **–ò–∑–º–µ–Ω–µ–Ω–æ:** ~30 —Å—Ç—Ä–æ–∫
- **–£–¥–∞–ª–µ–Ω–æ:** ~5 —Å—Ç—Ä–æ–∫

---

## –ü–†–û–í–ï–†–ö–ê –ö–ê–ß–ï–°–¢–í–ê

### –õ–∏–Ω—Ç–µ—Ä
‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ –ª–∏–Ω—Ç–µ—Ä–∞ –≤–æ –≤—Å–µ—Ö –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö

### –¢–∏–ø—ã
‚úÖ –í—Å–µ —Ç–∏–ø—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã, –Ω–µ—Ç –æ—à–∏–±–æ–∫ TypeScript

### –õ–æ–≥–∏–∫–∞
‚úÖ –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –Ω–µ –∏–∑–º–µ–Ω–µ–Ω–∞  
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏  
‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

---

## –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

1. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è invalidateSize –∏ setBounds:**
   - ‚úÖ –ö–∞—Ä—Ç–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ
   - ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ –∫–æ–Ω—Å–æ–ª–∏
   - ‚úÖ –ì—Ä–∞–Ω–∏—Ü—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –º–∞—Ä—à—Ä—É—Ç—É

2. **–í–∞–ª–∏–¥–∞—Ü–∏—è bounds:**
   - ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ –ø—Ä–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö bounds
   - ‚úÖ Fallback –Ω–∞ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
   - ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π —Ä–∞–±–æ—Ç–∞–µ—Ç

3. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –≤—ã–∑–æ–≤–æ–≤:**
   - ‚úÖ –ù–µ—Ç –ª–∏—à–Ω–∏—Ö –≤—ã–∑–æ–≤–æ–≤ `fitBounds()` –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –º–∞—Ä—à—Ä—É—Ç–æ–≤
   - ‚úÖ –ö–∞—Ä—Ç–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ bounds

4. **–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–æ–≤:**
   - ‚úÖ –ö–∞—Ä—Ç–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏
   - ‚úÖ –ù–µ—Ç –ø—Ä–æ–±–ª–µ–º —Å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∫–∞—Ä—Ç—ã

5. **Transfer –º–∞—Ä–∫–µ—Ä—ã:**
   - ‚úÖ Transfer –º–∞—Ä–∫–µ—Ä—ã –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –ø–æ–≤–µ—Ä—Ö –æ–±—ã—á–Ω—ã—Ö
   - ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è

---

## –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏ –≤—ã—Å–æ–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —É—Å–ø–µ—à–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã. –ú–æ–¥—É–ª—å Leaflet-–∫–∞—Ä—Ç—ã:

‚úÖ **–°—Ç–∞–±–∏–ª–µ–Ω** ‚Äî –Ω–µ—Ç –≥–æ–Ω–æ–∫ –∏ race conditions  
‚úÖ **–ù–∞–¥—ë–∂–µ–Ω** ‚Äî –ø–æ–ª–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö  
‚úÖ **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω** ‚Äî –Ω–µ—Ç –ª–∏—à–Ω–∏—Ö –≤—ã–∑–æ–≤–æ–≤  
‚úÖ **–ì–æ—Ç–æ–≤ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É** ‚Äî 100% –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ì–û–¢–û–í –ö –ü–†–û–î–ê–ö–®–ï–ù–£**

---

**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:** 2024  
**–í–µ—Ä—Å–∏—è:** 1.0.0  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ


