# План задач: Интеграция карты для мультимодальных маршрутов

**Дата:** 2025-01-27  
**Источник:** `MAP_Anilize.md`  
**Статус:** Структурированный план задач

---

## 1. Полный список задач

### Backend задачи

#### Архитектурные работы

**B-001:** Проектирование структуры данных `RouteMapDataResponse`  
**Описание:** Определить точную структуру ответа API согласно разделу 3.7 документа  
**Файл:** `backend/src/application/route-builder/use-cases/BuildRouteMapDataUseCase.ts`  
**Зависимости:** Нет

**B-002:** Проектирование структуры данных `RouteSegmentMapData`  
**Описание:** Определить структуру сегмента маршрута с координатами согласно разделу 3.7  
**Файл:** `backend/src/application/route-builder/use-cases/BuildRouteMapDataUseCase.ts`  
**Зависимости:** Нет

**B-003:** Проектирование алгоритма обогащения маршрутов координатами  
**Описание:** Реализовать алгоритм из раздела 3.4 с приоритетами источников координат  
**Файл:** `backend/src/application/route-builder/use-cases/BuildRouteMapDataUseCase.ts`  
**Зависимости:** B-001, B-002

**B-004:** Проектирование алгоритма расчёта bounds  
**Описание:** Реализовать алгоритм из раздела 3.6 с обработкой граничных случаев  
**Файл:** `backend/src/application/route-builder/use-cases/BuildRouteMapDataUseCase.ts`  
**Зависимости:** B-003

#### Создание файлов

**B-005:** Создать файл `polyline-builder.ts`  
**Описание:** Утилита для построения полилиний согласно разделу 3.8  
**Расположение:** `backend/src/shared/utils/polyline-builder.ts`  
**Зависимости:** Нет

**B-006:** Создать файл `BuildRouteMapDataUseCase.ts`  
**Описание:** Use Case для обогащения маршрута данными карты согласно разделу 3.3  
**Расположение:** `backend/src/application/route-builder/use-cases/BuildRouteMapDataUseCase.ts`  
**Зависимости:** B-005

**B-007:** Создать файл `RouteMapController.ts`  
**Описание:** Контроллер для endpoint `/api/v1/routes/map` согласно разделу 3.2  
**Расположение:** `backend/src/presentation/controllers/RouteMapController.ts`  
**Зависимости:** B-006

**B-008:** Создать Zod schema для валидации запроса  
**Описание:** Валидация `IBuiltRoute` в запросе согласно разделу 3.2  
**Расположение:** `backend/src/presentation/validators/route-map.validator.ts`  
**Зависимости:** Нет

#### Логика обработки маршрутов

**B-009:** Реализовать функцию `buildGreatCirclePolyline`  
**Описание:** Построение дуги большого круга для самолётов согласно разделу 3.5  
**Файл:** `backend/src/shared/utils/polyline-builder.ts`  
**Зависимости:** B-005

**B-010:** Реализовать функцию `buildStraightPolyline`  
**Описание:** Построение прямой линии для наземного транспорта согласно разделу 3.5  
**Файл:** `backend/src/shared/utils/polyline-builder.ts`  
**Зависимости:** B-005

**B-011:** Реализовать функцию `encodePolyline` (опционально)  
**Описание:** Кодирование полилинии в формат Google/Yandex согласно разделу 3.8  
**Файл:** `backend/src/shared/utils/polyline-builder.ts`  
**Зависимости:** B-005

**B-012:** Реализовать функцию `calculateDistance`  
**Описание:** Расчёт расстояния по формуле Haversine согласно разделу 3.8  
**Файл:** `backend/src/shared/utils/polyline-builder.ts`  
**Зависимости:** B-005

**B-013:** Реализовать валидацию входных данных в Use Case  
**Описание:** Проверка наличия `routeId`, `segments`, `fromCity`, `toCity` согласно разделу 3.3  
**Файл:** `backend/src/application/route-builder/use-cases/BuildRouteMapDataUseCase.ts`  
**Зависимости:** B-006

**B-014:** Реализовать инициализацию структур данных в Use Case  
**Описание:** Создание массивов и переменных для bounds согласно разделу 3.3  
**Файл:** `backend/src/application/route-builder/use-cases/BuildRouteMapDataUseCase.ts`  
**Зависимости:** B-006

**B-015:** Реализовать цикл обработки сегментов  
**Описание:** Обработка каждого сегмента с загрузкой координат согласно разделу 3.3  
**Файл:** `backend/src/application/route-builder/use-cases/BuildRouteMapDataUseCase.ts`  
**Зависимости:** B-003, B-009, B-010

**B-016:** Реализовать загрузку координат fromStop  
**Описание:** Приоритет: real stop → virtual stop → unified reference → default согласно разделу 3.4  
**Файл:** `backend/src/application/route-builder/use-cases/BuildRouteMapDataUseCase.ts`  
**Зависимости:** B-003

**B-017:** Реализовать загрузку координат toStop  
**Описание:** Приоритет: real stop → virtual stop → unified reference → default согласно разделу 3.4  
**Файл:** `backend/src/application/route-builder/use-cases/BuildRouteMapDataUseCase.ts`  
**Зависимости:** B-003

**B-018:** Реализовать выбор алгоритма построения полилинии  
**Описание:** Выбор Great Circle или Straight Line в зависимости от transportType согласно разделу 3.5  
**Файл:** `backend/src/application/route-builder/use-cases/BuildRouteMapDataUseCase.ts`  
**Зависимости:** B-009, B-010

**B-019:** Реализовать определение transfer точек  
**Описание:** Сравнение `toStop` предыдущего сегмента с `fromStop` текущего согласно разделу 3.3  
**Файл:** `backend/src/application/route-builder/use-cases/BuildRouteMapDataUseCase.ts`  
**Зависимости:** B-015

**B-020:** Реализовать расчёт общих границ карты  
**Описание:** Проход по всем координатам, нахождение min/max, добавление padding согласно разделу 3.6  
**Файл:** `backend/src/application/route-builder/use-cases/BuildRouteMapDataUseCase.ts`  
**Зависимости:** B-004

**B-021:** Реализовать обработку граничных случаев bounds  
**Описание:** Одна точка, пересечение 180-го меридиана, полярные регионы согласно разделу 3.6  
**Файл:** `backend/src/application/route-builder/use-cases/BuildRouteMapDataUseCase.ts`  
**Зависимости:** B-020

**B-022:** Реализовать формирование ответа RouteMapDataResponse  
**Описание:** Создание объекта с полями routeId, fromCity, toCity, segments, bounds согласно разделу 3.7  
**Файл:** `backend/src/application/route-builder/use-cases/BuildRouteMapDataUseCase.ts`  
**Зависимости:** B-015, B-020

**B-023:** Реализовать обработку ошибок в Use Case  
**Описание:** Fallback координаты, пропуск сегментов, логирование согласно разделу 3.3  
**Файл:** `backend/src/application/route-builder/use-cases/BuildRouteMapDataUseCase.ts`  
**Зависимости:** B-015

**B-024:** Реализовать endpoint POST `/api/v1/routes/map`  
**Описание:** Приём `IBuiltRoute` в body, валидация, вызов Use Case согласно разделу 3.2  
**Файл:** `backend/src/presentation/controllers/RouteMapController.ts`  
**Зависимости:** B-006, B-007, B-008

**B-025:** Зарегистрировать роут в `routes/index.ts`  
**Описание:** Добавить маршрут для POST `/api/v1/routes/map`  
**Файл:** `backend/src/presentation/routes/index.ts`  
**Зависимости:** B-024

#### Интеграция компонентов

**B-026:** Интегрировать IStopRepository в Use Case  
**Описание:** Использование `findRealStopById`, `findVirtualStopById` согласно разделу 3.9  
**Файл:** `backend/src/application/route-builder/use-cases/BuildRouteMapDataUseCase.ts`  
**Зависимости:** B-006

**B-027:** Интегрировать unified-cities-loader в Use Case  
**Описание:** Использование `getUnifiedCity` для fallback координат согласно разделу 3.9  
**Файл:** `backend/src/application/route-builder/use-cases/BuildRouteMapDataUseCase.ts`  
**Зависимости:** B-003

**B-028:** Использовать существующие типы IBuiltRoute, IRouteSegmentDetails  
**Описание:** Импорт типов из domain entities согласно разделу 3.9  
**Файл:** `backend/src/application/route-builder/use-cases/BuildRouteMapDataUseCase.ts`  
**Зависимости:** B-006

#### Оптимизация производительности

**B-029:** Реализовать оптимизацию для длинных маршрутов  
**Описание:** Увеличение шагов Great Circle для расстояний > 1000 км согласно разделу 3.5  
**Файл:** `backend/src/shared/utils/polyline-builder.ts`  
**Зависимости:** B-009

**B-030:** Реализовать оптимизацию для коротких маршрутов  
**Описание:** Уменьшение шагов Great Circle для расстояний < 10 км согласно разделу 3.5  
**Файл:** `backend/src/shared/utils/polyline-builder.ts`  
**Зависимости:** B-009

#### Тестирование

**B-031:** Написать unit тесты для `buildGreatCirclePolyline`  
**Описание:** Тестирование построения дуги большого круга  
**Файл:** `backend/src/shared/utils/__tests__/polyline-builder.test.ts`  
**Зависимости:** B-009

**B-032:** Написать unit тесты для `buildStraightPolyline`  
**Описание:** Тестирование построения прямой линии  
**Файл:** `backend/src/shared/utils/__tests__/polyline-builder.test.ts`  
**Зависимости:** B-010

**B-033:** Написать unit тесты для `calculateDistance`  
**Описание:** Тестирование расчёта расстояния по Haversine  
**Файл:** `backend/src/shared/utils/__tests__/polyline-builder.test.ts`  
**Зависимости:** B-012

**B-034:** Написать unit тесты для валидации входных данных Use Case  
**Описание:** Тестирование проверки обязательных полей  
**Файл:** `backend/src/application/route-builder/use-cases/__tests__/BuildRouteMapDataUseCase.test.ts`  
**Зависимости:** B-013

**B-035:** Написать unit тесты для обработки сегментов Use Case  
**Описание:** Тестирование цикла обработки сегментов с моками репозиториев  
**Файл:** `backend/src/application/route-builder/use-cases/__tests__/BuildRouteMapDataUseCase.test.ts`  
**Зависимости:** B-015

**B-036:** Написать unit тесты для расчёта bounds  
**Описание:** Тестирование алгоритма расчёта границ с padding  
**Файл:** `backend/src/application/route-builder/use-cases/__tests__/BuildRouteMapDataUseCase.test.ts`  
**Зависимости:** B-020

**B-037:** Написать integration тесты для RouteMapController  
**Описание:** Тестирование endpoint с реальными данными  
**Файл:** `backend/src/presentation/controllers/__tests__/RouteMapController.test.ts`  
**Зависимости:** B-024

**B-038:** Написать тесты для обработки граничных случаев  
**Описание:** Тестирование всех 7 граничных случаев из раздела 2.2 и 4.14  
**Файлы:** Различные тестовые файлы  
**Зависимости:** B-023, B-021

#### Проверка граничных случаев

**B-039:** Обработать маршрут с одним сегментом  
**Описание:** Один сегмент, два маркера (start, end), нет transfer согласно разделу 2.2  
**Файл:** `backend/src/application/route-builder/use-cases/BuildRouteMapDataUseCase.ts`  
**Зависимости:** B-015

**B-040:** Обработать маршрут с множеством сегментов  
**Описание:** Каждый сегмент отдельной полилинией, transfer markers согласно разделу 2.2  
**Файл:** `backend/src/application/route-builder/use-cases/BuildRouteMapDataUseCase.ts`  
**Зависимости:** B-015

**B-041:** Обработать отсутствие координат остановки  
**Описание:** Fallback на unified reference или default coordinates согласно разделу 2.2  
**Файл:** `backend/src/application/route-builder/use-cases/BuildRouteMapDataUseCase.ts`  
**Зависимости:** B-016, B-017

**B-042:** Обработать виртуальные остановки  
**Описание:** Координаты из unified reference, визуальное отличие согласно разделу 2.2  
**Файл:** `backend/src/application/route-builder/use-cases/BuildRouteMapDataUseCase.ts`  
**Зависимости:** B-016, B-017

**B-043:** Обработать очень длинные маршруты  
**Описание:** Оптимизация полилиний и маркеров согласно разделу 2.2  
**Файл:** `backend/src/application/route-builder/use-cases/BuildRouteMapDataUseCase.ts`  
**Зависимости:** B-029, B-030

**B-044:** Обработать маршрут без сегментов  
**Описание:** Возврат ошибки валидации согласно разделу 3.3  
**Файл:** `backend/src/application/route-builder/use-cases/BuildRouteMapDataUseCase.ts`  
**Зависимости:** B-013

**B-045:** Обработать сегмент без координат  
**Описание:** Пропуск сегмента с предупреждением согласно разделу 4.14  
**Файл:** `backend/src/application/route-builder/use-cases/BuildRouteMapDataUseCase.ts`  
**Зависимости:** B-023

**B-046:** Обработать ошибку загрузки данных карты  
**Описание:** Логирование ошибки, возврат корректного ответа согласно разделу 4.14  
**Файл:** `backend/src/presentation/controllers/RouteMapController.ts`  
**Зависимости:** B-024

---

### Frontend задачи

#### Архитектурные работы

**F-001:** Проектирование структуры модуля route-map  
**Описание:** Feature-Based Architecture согласно разделу 4.1  
**Расположение:** `frontend/src/modules/routes/features/route-map/`  
**Зависимости:** Нет

**F-002:** Проектирование интерфейса IMapProvider  
**Описание:** Абстракция картографических сервисов согласно разделу 4.2  
**Расположение:** `frontend/src/modules/routes/features/route-map/providers/map-provider.tsx`  
**Зависимости:** Нет

**F-003:** Проектирование структуры данных RouteMapData  
**Описание:** Внутренний формат данных карты согласно разделу 4.5  
**Расположение:** `frontend/src/modules/routes/features/route-map/types.ts`  
**Зависимости:** Нет

**F-004:** Проектирование структуры данных MapMarker  
**Описание:** Структура маркера с типами start/end/transfer согласно разделу 4.7  
**Расположение:** `frontend/src/modules/routes/features/route-map/types.ts`  
**Зависимости:** Нет

#### Создание файлов

**F-005:** Создать структуру модуля route-map  
**Описание:** Создать директории ui/, hooks/, lib/, providers/, types.ts, index.ts согласно разделу 4.1  
**Расположение:** `frontend/src/modules/routes/features/route-map/`  
**Зависимости:** F-001

**F-006:** Создать файл `types.ts`  
**Описание:** TypeScript типы RouteMapData, RouteSegmentMapData, MapMarker, MapBounds согласно разделу 4.5  
**Расположение:** `frontend/src/modules/routes/features/route-map/types.ts`  
**Зависимости:** F-003, F-004

**F-007:** Создать файл `map-data-adapter.ts`  
**Описание:** Адаптер данных IBuiltRoute → RouteMapData согласно разделу 4.5  
**Расположение:** `frontend/src/modules/routes/features/route-map/lib/map-data-adapter.ts`  
**Зависимости:** F-006

**F-008:** Создать файл `map-styles.ts`  
**Описание:** Цвета, иконки, labels для типов транспорта согласно разделу 4.6  
**Расположение:** `frontend/src/modules/routes/features/route-map/lib/map-styles.ts`  
**Зависимости:** Нет

**F-009:** Создать файл `marker-generator.ts`  
**Описание:** Генерация маркеров из RouteMapData согласно разделу 4.7  
**Расположение:** `frontend/src/modules/routes/features/route-map/lib/marker-generator.ts`  
**Зависимости:** F-006

**F-010:** Создать файл `use-route-map-data.ts`  
**Описание:** Хук загрузки данных карты через React Query согласно разделу 4.4  
**Расположение:** `frontend/src/modules/routes/features/route-map/hooks/use-route-map-data.ts`  
**Зависимости:** F-006

**F-011:** Создать файл `use-route-map-bounds.ts`  
**Описание:** Хук расчёта границ карты с мемоизацией согласно разделу 4.4  
**Расположение:** `frontend/src/modules/routes/features/route-map/hooks/use-route-map-bounds.ts`  
**Зависимости:** F-006

**F-012:** Создать файл `use-route-map-segments.ts`  
**Описание:** Хук обработки сегментов для легенды согласно разделу 4.4  
**Расположение:** `frontend/src/modules/routes/features/route-map/hooks/use-route-map-segments.ts`  
**Зависимости:** F-006

**F-013:** Создать файл `route-map.tsx`  
**Описание:** Основной компонент карты согласно разделу 4.3  
**Расположение:** `frontend/src/modules/routes/features/route-map/ui/route-map.tsx`  
**Зависимости:** F-010, F-011, F-012

**F-014:** Создать файл `route-map-legend.tsx`  
**Описание:** Компонент легенды типов транспорта согласно разделу 4.6  
**Расположение:** `frontend/src/modules/routes/features/route-map/ui/route-map-legend.tsx`  
**Зависимости:** F-008

**F-015:** Создать файл `route-map-controls.tsx` (опционально)  
**Описание:** Элементы управления картой (zoom, center)  
**Расположение:** `frontend/src/modules/routes/features/route-map/ui/route-map-controls.tsx`  
**Зависимости:** F-013

**F-016:** Создать файл `route-map-popup.tsx`  
**Описание:** Popup с информацией о сегменте/маркере  
**Расположение:** `frontend/src/modules/routes/features/route-map/ui/route-map-popup.tsx`  
**Зависимости:** F-013

**F-017:** Создать файл `route-map-api.ts`  
**Описание:** API клиент для запросов к `/api/v1/routes/map`  
**Расположение:** `frontend/src/modules/routes/lib/route-map-api.ts`  
**Зависимости:** Нет

**F-018:** Создать файл `map-provider.tsx` (опционально)  
**Описание:** Провайдер для абстракции картографических сервисов согласно разделу 4.2  
**Расположение:** `frontend/src/modules/routes/features/route-map/providers/map-provider.tsx`  
**Зависимости:** F-002

#### Модульная структура

**F-019:** Создать index.ts для ui/  
**Описание:** Экспорт всех UI компонентов  
**Расположение:** `frontend/src/modules/routes/features/route-map/ui/index.ts`  
**Зависимости:** F-013, F-014, F-015, F-016

**F-020:** Создать index.ts для hooks/  
**Описание:** Экспорт всех хуков  
**Расположение:** `frontend/src/modules/routes/features/route-map/hooks/index.ts`  
**Зависимости:** F-010, F-011, F-012

**F-021:** Создать index.ts для lib/  
**Описание:** Экспорт всех утилит  
**Расположение:** `frontend/src/modules/routes/features/route-map/lib/index.ts`  
**Зависимости:** F-007, F-008, F-009

**F-022:** Создать публичный index.ts модуля  
**Описание:** Экспорт публичного API модуля route-map  
**Расположение:** `frontend/src/modules/routes/features/route-map/index.ts`  
**Зависимости:** F-019, F-020, F-021

#### Логика обработки маршрутов

**F-023:** Реализовать функцию `adaptRouteToMapData`  
**Описание:** Преобразование IBuiltRoute + RouteMapDataResponse → RouteMapData согласно разделу 4.5  
**Файл:** `frontend/src/modules/routes/features/route-map/lib/map-data-adapter.ts`  
**Зависимости:** F-007

**F-024:** Реализовать функцию `generateMapMarkers`  
**Описание:** Генерация маркеров start/end/transfer согласно разделу 4.7  
**Файл:** `frontend/src/modules/routes/features/route-map/lib/marker-generator.ts`  
**Зависимости:** F-009

**F-025:** Реализовать алгоритм определения transfer точек  
**Описание:** Сравнение fromStopId с previousToStopId согласно разделу 4.5  
**Файл:** `frontend/src/modules/routes/features/route-map/lib/marker-generator.ts`  
**Зависимости:** F-024

**F-026:** Реализовать обработку дубликатов маркеров  
**Описание:** Использование Set для отслеживания уже добавленных остановок согласно разделу 4.7  
**Файл:** `frontend/src/modules/routes/features/route-map/lib/marker-generator.ts`  
**Зависимости:** F-024

**F-027:** Реализовать загрузку данных через React Query  
**Описание:** POST запрос на `/api/v1/routes/map` с кэшированием согласно разделу 4.4  
**Файл:** `frontend/src/modules/routes/features/route-map/hooks/use-route-map-data.ts`  
**Зависимости:** F-010, F-017

**F-028:** Реализовать расчёт bounds с мемоизацией  
**Описание:** Проход по координатам, min/max, padding 15% согласно разделу 4.4  
**Файл:** `frontend/src/modules/routes/features/route-map/hooks/use-route-map-bounds.ts`  
**Зависимости:** F-011

**F-029:** Реализовать обработку сегментов для легенды  
**Описание:** Группировка по типу транспорта, определение видимости согласно разделу 4.4  
**Файл:** `frontend/src/modules/routes/features/route-map/hooks/use-route-map-segments.ts`  
**Зависимости:** F-012

#### Интеграция компонентов

**F-030:** Реализовать инициализацию карты в RouteMap  
**Описание:** Использование useRouteMapData, useRouteMapBounds согласно разделу 4.3  
**Файл:** `frontend/src/modules/routes/features/route-map/ui/route-map.tsx`  
**Зависимости:** F-013, F-027, F-028

**F-031:** Реализовать рендеринг сегментов в RouteMap  
**Описание:** Цикл по mapData.segments, создание полилиний согласно разделу 4.11  
**Файл:** `frontend/src/modules/routes/features/route-map/ui/route-map.tsx`  
**Зависимости:** F-013, F-023

**F-032:** Реализовать рендеринг маркеров в RouteMap  
**Описание:** Использование generateMapMarkers, создание маркеров согласно разделу 4.11  
**Файл:** `frontend/src/modules/routes/features/route-map/ui/route-map.tsx`  
**Зависимости:** F-013, F-024

**F-033:** Реализовать установку границ карты  
**Описание:** Вызов setBounds с рассчитанными bounds согласно разделу 4.11  
**Файл:** `frontend/src/modules/routes/features/route-map/ui/route-map.tsx`  
**Зависимости:** F-013, F-028

**F-034:** Реализовать обработку взаимодействий  
**Описание:** Обработчики клика на полилинии и маркеры согласно разделу 4.11  
**Файл:** `frontend/src/modules/routes/features/route-map/ui/route-map.tsx`  
**Зависимости:** F-013

**F-035:** Реализовать очистку при размонтировании  
**Описание:** Удаление полилиний и маркеров, освобождение ресурсов согласно разделу 4.11  
**Файл:** `frontend/src/modules/routes/features/route-map/ui/route-map.tsx`  
**Зависимости:** F-013

**F-036:** Интегрировать RouteMap в RouteDetailsView  
**Описание:** Добавить секцию с картой, переключение showMap согласно разделу 4.15  
**Файл:** `frontend/src/modules/routes/features/route-details/ui/route-details-view.tsx`  
**Зависимости:** F-013, F-022

**F-037:** Интегрировать RouteMap в RouteListItem (опционально)  
**Описание:** Условный рендеринг карты в списке маршрутов согласно разделу 4.15  
**Файл:** `frontend/src/modules/routes/features/route-list/ui/routes-section.tsx`  
**Зависимости:** F-013, F-022

#### Обработка альтернатив

**F-038:** Реализовать переключение альтернативных маршрутов  
**Описание:** Кнопки "Предыдущий"/"Следующий", обновление карты согласно разделу 4.12  
**Файл:** `frontend/src/modules/routes/features/route-details/ui/route-details-view.tsx`  
**Зависимости:** F-013, F-036

**F-039:** Реализовать плавное обновление карты при переключении  
**Описание:** Очистка карты, загрузка новых данных, плавный переход согласно разделу 4.12  
**Файл:** `frontend/src/modules/routes/features/route-map/ui/route-map.tsx`  
**Зависимости:** F-013, F-035

**F-040:** Реализовать сохранение позиции карты при переключении (опционально)  
**Описание:** Сохранение center и zoom при смене маршрута  
**Файл:** `frontend/src/modules/routes/features/route-map/ui/route-map.tsx`  
**Зависимости:** F-013

**F-041:** Реализовать синхронизацию с списком сегментов  
**Описание:** Клик на сегмент в списке → подсветка на карте согласно разделу 4.10  
**Файл:** `frontend/src/modules/routes/features/route-details/ui/route-details-view.tsx`  
**Зависимости:** F-013, F-034, F-036

#### Оптимизация производительности

**F-042:** Реализовать мемоизацию вычислений  
**Описание:** useMemo для bounds, маркеров, сегментов согласно разделу 4.13  
**Файлы:** Различные компоненты и хуки  
**Зависимости:** F-028, F-024

**F-043:** Реализовать ленивую загрузку данных карты  
**Описание:** Загрузка только при открытии карты согласно разделу 4.13  
**Файл:** `frontend/src/modules/routes/features/route-map/hooks/use-route-map-data.ts`  
**Зависимости:** F-027

**F-044:** Реализовать упрощение полилиний при малом zoom  
**Описание:** Меньше точек при zoom < 5 согласно разделу 4.13  
**Файл:** `frontend/src/modules/routes/features/route-map/ui/route-map.tsx`  
**Зависимости:** F-013

**F-045:** Реализовать кластеризацию маркеров (опционально)  
**Описание:** Группировка близких маркеров, раскрытие при увеличении zoom согласно разделу 4.13  
**Файл:** `frontend/src/modules/routes/features/route-map/ui/route-map.tsx`  
**Зависимости:** F-013

**F-046:** Реализовать debounce для обработки событий  
**Описание:** Debounce для частых обновлений при изменении zoom согласно разделу 4.13  
**Файл:** `frontend/src/modules/routes/features/route-map/ui/route-map.tsx`  
**Зависимости:** F-013

#### Интеграция с картографическими сервисами

**F-047:** Установить зависимости для Yandex Maps  
**Описание:** `@pbe/react-yandex-maps`, `yandex-maps` согласно разделу 4.8  
**Команда:** `npm install @pbe/react-yandex-maps yandex-maps`  
**Зависимости:** Нет

**F-048:** Установить зависимости для Leaflet (альтернатива)  
**Описание:** `leaflet`, `react-leaflet`, `@types/leaflet` согласно разделу 4.9  
**Команда:** `npm install leaflet react-leaflet @types/leaflet`  
**Зависимости:** Нет

**F-049:** Настроить API ключ Yandex Maps  
**Описание:** Добавить `NEXT_PUBLIC_YANDEX_MAPS_API_KEY` в `.env.local` согласно разделу 4.8  
**Файл:** `frontend/.env.local`  
**Зависимости:** F-047

**F-050:** Реализовать инициализацию Yandex Maps  
**Описание:** Компонент `<YMaps>`, `<Map>` согласно разделу 4.8  
**Файл:** `frontend/src/modules/routes/features/route-map/ui/route-map.tsx`  
**Зависимости:** F-013, F-047, F-049

**F-051:** Реализовать отображение полилиний в Yandex Maps  
**Описание:** Компонент `<Polyline>` с координатами и стилями согласно разделу 4.8  
**Файл:** `frontend/src/modules/routes/features/route-map/ui/route-map.tsx`  
**Зависимости:** F-050, F-031

**F-052:** Реализовать отображение маркеров в Yandex Maps  
**Описание:** Компонент `<Placemark>` с позицией и опциями согласно разделу 4.8  
**Файл:** `frontend/src/modules/routes/features/route-map/ui/route-map.tsx`  
**Зависимости:** F-050, F-032

**F-053:** Реализовать инициализацию Leaflet (альтернатива)  
**Описание:** `L.map()`, tile layer, полилинии и маркеры согласно разделу 4.9  
**Файл:** `frontend/src/modules/routes/features/route-map/ui/route-map-leaflet.tsx`  
**Зависимости:** F-013, F-048

#### Тестирование

**F-054:** Написать unit тесты для адаптера данных  
**Описание:** Тестирование adaptRouteToMapData, generateMapMarkers согласно разделу 4.16  
**Файл:** `frontend/src/modules/routes/features/route-map/lib/__tests__/map-data-adapter.test.ts`  
**Зависимости:** F-023, F-024

**F-055:** Написать unit тесты для утилит  
**Описание:** Тестирование расчёта bounds, стилизации сегментов согласно разделу 4.16  
**Файлы:** Различные тестовые файлы  
**Зависимости:** F-028, F-008

**F-056:** Написать unit тесты для хуков  
**Описание:** Тестирование useRouteMapData, useRouteMapBounds, мемоизации согласно разделу 4.16  
**Файлы:** Различные тестовые файлы  
**Зависимости:** F-027, F-028, F-029

**F-057:** Написать integration тесты для RouteMap  
**Описание:** Тестирование инициализации, отображения сегментов и маркеров согласно разделу 4.16  
**Файл:** `frontend/src/modules/routes/features/route-map/ui/__tests__/route-map.test.tsx`  
**Зависимости:** F-013

**F-058:** Написать integration тесты для API  
**Описание:** Тестирование загрузки данных через API, обработки ошибок согласно разделу 4.16  
**Файл:** `frontend/src/modules/routes/lib/__tests__/route-map-api.test.ts`  
**Зависимости:** F-017, F-027

**F-059:** Написать E2E тест: Поиск маршрута и отображение на карте  
**Описание:** Сценарий из раздела 4.16  
**Файл:** `frontend/e2e/route-map.spec.ts`  
**Зависимости:** F-013, F-036

**F-060:** Написать E2E тест: Переключение альтернативных маршрутов  
**Описание:** Сценарий из раздела 4.16  
**Файл:** `frontend/e2e/route-map.spec.ts`  
**Зависимости:** F-038

#### Проверка граничных случаев

**F-061:** Обработать маршрут без сегментов  
**Описание:** Отображение сообщения "Маршрут не содержит сегментов" согласно разделу 4.14  
**Файл:** `frontend/src/modules/routes/features/route-map/ui/route-map.tsx`  
**Зависимости:** F-013

**F-062:** Обработать сегмент без координат  
**Описание:** Пропуск сегмента с предупреждением, отображение остальных согласно разделу 4.14  
**Файл:** `frontend/src/modules/routes/features/route-map/ui/route-map.tsx`  
**Зависимости:** F-013

**F-063:** Обработать ошибку загрузки данных карты  
**Описание:** Сообщение об ошибке, кнопка "Повторить попытку" согласно разделу 4.14  
**Файл:** `frontend/src/modules/routes/features/route-map/ui/route-map.tsx`  
**Зависимости:** F-013, F-027

**F-064:** Обработать карту не инициализирована  
**Описание:** Проверка API ключа, сообщение о настройке, fallback на Leaflet согласно разделу 4.14  
**Файл:** `frontend/src/modules/routes/features/route-map/ui/route-map.tsx`  
**Зависимости:** F-013, F-049

**F-065:** Обработать очень длинный маршрут  
**Описание:** Специальная обработка bounds, упрощение полилиний согласно разделу 4.14  
**Файл:** `frontend/src/modules/routes/features/route-map/ui/route-map.tsx`  
**Зависимости:** F-013, F-044

**F-066:** Обработать маршрут с одним сегментом  
**Описание:** Нормальная обработка, без transfer markers согласно разделу 4.14  
**Файл:** `frontend/src/modules/routes/features/route-map/lib/marker-generator.ts`  
**Зависимости:** F-024

---

## 2. Группировка задач по этапам

### Этап 1: Backend — Инфраструктура (2-3 часа)

**Задачи:**
- B-005: Создать файл `polyline-builder.ts`
- B-009: Реализовать функцию `buildGreatCirclePolyline`
- B-010: Реализовать функцию `buildStraightPolyline`
- B-011: Реализовать функцию `encodePolyline` (опционально)
- B-012: Реализовать функцию `calculateDistance`
- B-006: Создать файл `BuildRouteMapDataUseCase.ts`
- B-001: Проектирование структуры данных `RouteMapDataResponse`
- B-002: Проектирование структуры данных `RouteSegmentMapData`
- B-003: Проектирование алгоритма обогащения маршрутов координатами
- B-004: Проектирование алгоритма расчёта bounds
- B-013: Реализовать валидацию входных данных в Use Case
- B-014: Реализовать инициализацию структур данных в Use Case
- B-015: Реализовать цикл обработки сегментов
- B-016: Реализовать загрузку координат fromStop
- B-017: Реализовать загрузку координат toStop
- B-018: Реализовать выбор алгоритма построения полилинии
- B-019: Реализовать определение transfer точек
- B-020: Реализовать расчёт общих границ карты
- B-021: Реализовать обработку граничных случаев bounds
- B-022: Реализовать формирование ответа RouteMapDataResponse
- B-023: Реализовать обработку ошибок в Use Case
- B-007: Создать файл `RouteMapController.ts`
- B-008: Создать Zod schema для валидации запроса
- B-024: Реализовать endpoint POST `/api/v1/routes/map`
- B-025: Зарегистрировать роут в `routes/index.ts`
- B-026: Интегрировать IStopRepository в Use Case
- B-027: Интегрировать unified-cities-loader в Use Case
- B-028: Использовать существующие типы IBuiltRoute, IRouteSegmentDetails
- B-029: Реализовать оптимизацию для длинных маршрутов
- B-030: Реализовать оптимизацию для коротких маршрутов

**Критерии готовности:**
- Endpoint возвращает корректные данные для тестового маршрута
- Все сегменты обогащены координатами
- Полилинии построены корректно
- Bounds рассчитаны правильно

---

### Этап 2: Backend — Тестирование (1-2 часа)

**Задачи:**
- B-031: Написать unit тесты для `buildGreatCirclePolyline`
- B-032: Написать unit тесты для `buildStraightPolyline`
- B-033: Написать unit тесты для `calculateDistance`
- B-034: Написать unit тесты для валидации входных данных Use Case
- B-035: Написать unit тесты для обработки сегментов Use Case
- B-036: Написать unit тесты для расчёта bounds
- B-037: Написать integration тесты для RouteMapController
- B-038: Написать тесты для обработки граничных случаев
- B-039: Обработать маршрут с одним сегментом
- B-040: Обработать маршрут с множеством сегментов
- B-041: Обработать отсутствие координат остановки
- B-042: Обработать виртуальные остановки
- B-043: Обработать очень длинные маршруты
- B-044: Обработать маршрут без сегментов
- B-045: Обработать сегмент без координат
- B-046: Обработать ошибку загрузки данных карты

**Критерии готовности:**
- Покрытие тестами > 80%
- Все граничные случаи обработаны
- Ошибки логируются корректно

---

### Этап 3: Frontend — Инфраструктура (1-2 часа)

**Задачи:**
- F-001: Проектирование структуры модуля route-map
- F-002: Проектирование интерфейса IMapProvider
- F-003: Проектирование структуры данных RouteMapData
- F-004: Проектирование структуры данных MapMarker
- F-005: Создать структуру модуля route-map
- F-006: Создать файл `types.ts`
- F-007: Создать файл `map-data-adapter.ts`
- F-008: Создать файл `map-styles.ts`
- F-009: Создать файл `marker-generator.ts`
- F-017: Создать файл `route-map-api.ts`
- F-019: Создать index.ts для ui/
- F-020: Создать index.ts для hooks/
- F-021: Создать index.ts для lib/
- F-022: Создать публичный index.ts модуля
- F-047: Установить зависимости для Yandex Maps
- F-048: Установить зависимости для Leaflet (альтернатива)
- F-049: Настроить API ключ Yandex Maps

**Критерии готовности:**
- Модуль создан и структурирован
- Типы определены
- Адаптер преобразует данные корректно

---

### Этап 4: Frontend — Хуки (1-2 часа)

**Задачи:**
- F-010: Создать файл `use-route-map-data.ts`
- F-011: Создать файл `use-route-map-bounds.ts`
- F-012: Создать файл `use-route-map-segments.ts`
- F-023: Реализовать функцию `adaptRouteToMapData`
- F-024: Реализовать функцию `generateMapMarkers`
- F-025: Реализовать алгоритм определения transfer точек
- F-026: Реализовать обработку дубликатов маркеров
- F-027: Реализовать загрузку данных через React Query
- F-028: Реализовать расчёт bounds с мемоизацией
- F-029: Реализовать обработку сегментов для легенды

**Критерии готовности:**
- Хуки работают корректно
- Кэширование работает
- Ошибки обрабатываются

---

### Этап 5: Frontend — Компоненты (4-6 часов)

**Задачи:**
- F-013: Создать файл `route-map.tsx`
- F-014: Создать файл `route-map-legend.tsx`
- F-015: Создать файл `route-map-controls.tsx` (опционально)
- F-016: Создать файл `route-map-popup.tsx`
- F-030: Реализовать инициализацию карты в RouteMap
- F-031: Реализовать рендеринг сегментов в RouteMap
- F-032: Реализовать рендеринг маркеров в RouteMap
- F-033: Реализовать установку границ карты
- F-034: Реализовать обработку взаимодействий
- F-035: Реализовать очистку при размонтировании
- F-050: Реализовать инициализацию Yandex Maps
- F-051: Реализовать отображение полилиний в Yandex Maps
- F-052: Реализовать отображение маркеров в Yandex Maps
- F-053: Реализовать инициализацию Leaflet (альтернатива)
- F-042: Реализовать мемоизацию вычислений
- F-043: Реализовать ленивую загрузку данных карты
- F-044: Реализовать упрощение полилиний при малом zoom
- F-045: Реализовать кластеризацию маркеров (опционально)
- F-046: Реализовать debounce для обработки событий

**Критерии готовности:**
- Карта отображается корректно
- Сегменты отображаются с правильными цветами
- Маркеры отображаются корректно
- Клики обрабатываются

---

### Этап 6: Frontend — Интеграция (2-3 часа)

**Задачи:**
- F-036: Интегрировать RouteMap в RouteDetailsView
- F-037: Интегрировать RouteMap в RouteListItem (опционально)
- F-038: Реализовать переключение альтернативных маршрутов
- F-039: Реализовать плавное обновление карты при переключении
- F-040: Реализовать сохранение позиции карты при переключении (опционально)
- F-041: Реализовать синхронизацию с списком сегментов

**Критерии готовности:**
- Карта отображается на странице деталей
- Переключение маршрутов работает
- Синхронизация работает корректно

---

### Этап 7: Тестирование и полировка (2-3 часа)

**Задачи:**
- F-054: Написать unit тесты для адаптера данных
- F-055: Написать unit тесты для утилит
- F-056: Написать unit тесты для хуков
- F-057: Написать integration тесты для RouteMap
- F-058: Написать integration тесты для API
- F-059: Написать E2E тест: Поиск маршрута и отображение на карте
- F-060: Написать E2E тест: Переключение альтернативных маршрутов
- F-061: Обработать маршрут без сегментов
- F-062: Обработать сегмент без координат
- F-063: Обработать ошибку загрузки данных карты
- F-064: Обработать карту не инициализирована
- F-065: Обработать очень длинный маршрут
- F-066: Обработать маршрут с одним сегментом

**Критерии готовности:**
- Все тесты проходят
- Нет критических багов
- Производительность приемлемая

---

## 3. Критерии готовности по этапам

### Этап 1: Backend — Инфраструктура

**Критерии готовности:**
- ✅ Endpoint возвращает корректные данные для тестового маршрута
- ✅ Все сегменты обогащены координатами
- ✅ Полилинии построены корректно
- ✅ Bounds рассчитаны правильно

**Проверка:**
- POST запрос на `/api/v1/routes/map` с тестовым `IBuiltRoute` возвращает `RouteMapDataResponse`
- Все сегменты содержат координаты `fromStop` и `toStop`
- Полилинии для PLANE используют Great Circle (50+ точек)
- Полилинии для других типов используют Straight Line (2 точки)
- Bounds содержат корректные значения north/south/east/west с padding

---

### Этап 2: Backend — Тестирование

**Критерии готовности:**
- ✅ Покрытие тестами > 80%
- ✅ Все граничные случаи обработаны
- ✅ Ошибки логируются корректно

**Проверка:**
- Запуск `npm test` показывает покрытие > 80% для новых файлов
- Все 7 граничных случаев из раздела 2.2 покрыты тестами
- Логи содержат предупреждения и ошибки с контекстом

---

### Этап 3: Frontend — Инфраструктура

**Критерии готовности:**
- ✅ Модуль создан и структурирован
- ✅ Типы определены
- ✅ Адаптер преобразует данные корректно

**Проверка:**
- Структура модуля `route-map/` соответствует разделу 4.1
- TypeScript компилируется без ошибок
- Функция `adaptRouteToMapData` преобразует тестовые данные корректно

---

### Этап 4: Frontend — Хуки

**Критерии готовности:**
- ✅ Хуки работают корректно
- ✅ Кэширование работает
- ✅ Ошибки обрабатываются

**Проверка:**
- `useRouteMapData` загружает данные через API
- React Query кэширует данные по `routeId`
- `useRouteMapBounds` рассчитывает bounds с мемоизацией
- Ошибки обрабатываются и возвращаются в состоянии error

---

### Этап 5: Frontend — Компоненты

**Критерии готовности:**
- ✅ Карта отображается корректно
- ✅ Сегменты отображаются с правильными цветами
- ✅ Маркеры отображаются корректно
- ✅ Клики обрабатываются

**Проверка:**
- Компонент `RouteMap` инициализирует карту (Yandex Maps или Leaflet)
- Все сегменты отображаются полилиниями с цветами согласно `transportType`
- Маркеры start/end/transfer отображаются в правильных позициях
- Клик на сегмент вызывает callback `onSegmentClick`

---

### Этап 6: Frontend — Интеграция

**Критерии готовности:**
- ✅ Карта отображается на странице деталей
- ✅ Переключение маршрутов работает
- ✅ Синхронизация работает корректно

**Проверка:**
- На странице `/routes/details` отображается секция с картой
- Кнопки "Предыдущий"/"Следующий" переключают альтернативные маршруты
- Карта обновляется при переключении
- Клик на сегмент в списке подсвечивает сегмент на карте

---

### Этап 7: Тестирование и полировка

**Критерии готовности:**
- ✅ Все тесты проходят
- ✅ Нет критических багов
- ✅ Производительность приемлемая

**Проверка:**
- Все unit, integration и E2E тесты проходят
- Ручное тестирование не выявляет критических багов
- Производительность: карта загружается < 2 секунд, рендеринг < 500ms

---

## 4. Приоритизация задач

### Критические зависимости (блокеры)

**Блокер 1: Backend endpoint должен быть готов до Frontend хуков**
- **Блокирует:** F-027 (загрузка данных через React Query)
- **Причина:** Frontend не может загружать данные без работающего API
- **Решение:** Этап 1 (Backend) должен быть завершён перед Этапом 4 (Frontend хуки)

**Блокер 2: Типы должны быть определены до адаптера**
- **Блокирует:** F-023 (adaptRouteToMapData)
- **Причина:** Адаптер использует типы RouteMapData
- **Решение:** F-006 (types.ts) должен быть создан перед F-007 (map-data-adapter.ts)

**Блокер 3: Адаптер должен быть готов до компонентов**
- **Блокирует:** F-031 (рендеринг сегментов)
- **Причина:** Компонент использует адаптер для преобразования данных
- **Решение:** F-023 (adaptRouteToMapData) должен быть реализован перед F-031

**Блокер 4: Хуки должны быть готовы до компонентов**
- **Блокирует:** F-030 (инициализация карты)
- **Причина:** Компонент использует хуки для загрузки данных
- **Решение:** Этап 4 (Хуки) должен быть завершён перед Этапом 5 (Компоненты)

### Порядок выполнения этапов

**Последовательность (строго):**
1. **Этап 1: Backend — Инфраструктура** (первый, блокер для Frontend)
2. **Этап 2: Backend — Тестирование** (после Этапа 1)
3. **Этап 3: Frontend — Инфраструктура** (можно параллельно с Этапом 2)
4. **Этап 4: Frontend — Хуки** (после Этапов 1 и 3)
5. **Этап 5: Frontend — Компоненты** (после Этапа 4)
6. **Этап 6: Frontend — Интеграция** (после Этапа 5)
7. **Этап 7: Тестирование и полировка** (после Этапа 6)

### Параллельное выполнение

**Можно выполнять параллельно:**
- **Этап 2 (Backend тестирование)** и **Этап 3 (Frontend инфраструктура)** — независимы
- **F-047 (Yandex Maps)** и **F-048 (Leaflet)** — альтернативные варианты
- **F-015 (route-map-controls)** и **F-016 (route-map-popup)** — опциональные компоненты
- **F-037 (RouteListItem интеграция)** — опциональная интеграция
- **F-045 (кластеризация маркеров)** — опциональная оптимизация
- **B-011 (encodePolyline)** — опциональная функция

### Приоритеты задач внутри этапов

**Этап 1 (Backend — Инфраструктура):**
1. **Высокий приоритет (критично):**
   - B-005, B-009, B-010, B-012 (полилинии и расстояние)
   - B-006, B-001, B-002 (Use Case и структуры данных)
   - B-015, B-016, B-017 (обработка сегментов и координат)
   - B-020, B-022 (bounds и формирование ответа)
   - B-007, B-024, B-025 (контроллер и endpoint)

2. **Средний приоритет (важно):**
   - B-003, B-004 (алгоритмы обогащения и bounds)
   - B-013, B-014 (валидация и инициализация)
   - B-018, B-019 (выбор алгоритма и transfer точки)
   - B-026, B-027, B-028 (интеграция с существующими компонентами)

3. **Низкий приоритет (можно отложить):**
   - B-011 (encodePolyline) — опционально
   - B-021 (граничные случаи bounds) — можно упростить для MVP
   - B-029, B-030 (оптимизации) — можно добавить позже

**Этап 2 (Backend — Тестирование):**
1. **Высокий приоритет:**
   - B-031, B-032, B-033 (unit тесты для полилиний)
   - B-034, B-035 (unit тесты для Use Case)
   - B-037 (integration тесты для контроллера)

2. **Средний приоритет:**
   - B-036 (тесты для bounds)
   - B-039, B-040, B-041 (граничные случаи)

3. **Низкий приоритет:**
   - B-038 (все граничные случаи) — можно покрыть постепенно
   - B-042, B-043, B-044, B-045, B-046 (дополнительные граничные случаи)

**Этап 3 (Frontend — Инфраструктура):**
1. **Высокий приоритет:**
   - F-001, F-003, F-004 (проектирование структур)
   - F-005, F-006 (создание модуля и типов)
   - F-007, F-008, F-009 (адаптер, стили, генератор маркеров)
   - F-017 (API клиент)

2. **Средний приоритет:**
   - F-002 (IMapProvider) — можно отложить, если используем только Yandex Maps
   - F-019, F-020, F-021, F-022 (index.ts файлы)

3. **Низкий приоритет:**
   - F-047, F-048 (зависимости) — можно установить позже
   - F-049 (API ключ) — нужен только для Yandex Maps

**Этап 4 (Frontend — Хуки):**
1. **Высокий приоритет:**
   - F-027 (useRouteMapData) — критично для загрузки данных
   - F-028 (useRouteMapBounds) — критично для позиционирования карты
   - F-023, F-024 (адаптер и генератор маркеров)

2. **Средний приоритет:**
   - F-025, F-026 (определение transfer и дубликатов)
   - F-029 (обработка сегментов для легенды)

**Этап 5 (Frontend — Компоненты):**
1. **Высокий приоритет:**
   - F-013 (RouteMap) — основной компонент
   - F-030, F-031, F-032 (инициализация, рендеринг сегментов и маркеров)
   - F-033, F-034, F-035 (управление картой и очистка)
   - F-050, F-051, F-052 (интеграция с Yandex Maps)

2. **Средний приоритет:**
   - F-014 (RouteMapLegend) — важна для UX
   - F-042, F-043 (мемоизация и ленивая загрузка)

3. **Низкий приоритет:**
   - F-015, F-016 (опциональные компоненты)
   - F-044, F-045, F-046 (оптимизации производительности)
   - F-053 (Leaflet альтернатива)

**Этап 6 (Frontend — Интеграция):**
1. **Высокий приоритет:**
   - F-036 (интеграция в RouteDetailsView) — основная интеграция
   - F-038 (переключение альтернативных маршрутов)

2. **Средний приоритет:**
   - F-039 (плавное обновление карты)
   - F-041 (синхронизация с списком сегментов)

3. **Низкий приоритет:**
   - F-037 (RouteListItem) — опционально
   - F-040 (сохранение позиции карты) — опционально

**Этап 7 (Тестирование и полировка):**
1. **Высокий приоритет:**
   - F-054, F-055 (unit тесты для адаптера и утилит)
   - F-057 (integration тесты для RouteMap)
   - F-061, F-062, F-063 (обработка основных граничных случаев)

2. **Средний приоритет:**
   - F-056 (unit тесты для хуков)
   - F-058 (integration тесты для API)
   - F-064, F-065, F-066 (дополнительные граничные случаи)

3. **Низкий приоритет:**
   - F-059, F-060 (E2E тесты) — можно добавить позже

---

## 5. Итоговое резюме

### Порядок выполнения работ

**Фаза 1: Backend Foundation (3-5 часов)**
1. Начать с **Этапа 1: Backend — Инфраструктура**
   - Создать утилиты для полилиний (B-005, B-009, B-010, B-012)
   - Реализовать Use Case для обогащения маршрутов (B-006, B-015, B-016, B-017, B-020, B-022)
   - Создать контроллер и endpoint (B-007, B-024, B-025)
   - Интегрировать с существующими компонентами (B-026, B-027, B-028)

2. Продолжить с **Этапа 2: Backend — Тестирование**
   - Написать критичные unit тесты (B-031, B-032, B-033, B-034, B-035)
   - Написать integration тесты (B-037)
   - Покрыть основные граничные случаи (B-039, B-040, B-041)

**Фаза 2: Frontend Foundation (2-4 часа)**
3. Параллельно с Этапом 2 начать **Этап 3: Frontend — Инфраструктура**
   - Создать структуру модуля route-map (F-001, F-005)
   - Определить типы (F-003, F-004, F-006)
   - Создать адаптер, стили, генератор маркеров (F-007, F-008, F-009)
   - Создать API клиент (F-017)

4. После завершения Этапа 1 перейти к **Этапу 4: Frontend — Хуки**
   - Реализовать загрузку данных (F-027)
   - Реализовать расчёт bounds (F-028)
   - Реализовать адаптер и генератор маркеров (F-023, F-024)

**Фаза 3: Frontend Components (4-6 часов)**
5. После завершения Этапа 4 начать **Этап 5: Frontend — Компоненты**
   - Создать основной компонент RouteMap (F-013)
   - Реализовать инициализацию и рендеринг (F-030, F-031, F-032)
   - Интегрировать с Yandex Maps (F-050, F-051, F-052)
   - Добавить легенду (F-014)
   - Реализовать базовые оптимизации (F-042, F-043)

**Фаза 4: Integration (2-3 часа)**
6. После завершения Этапа 5 начать **Этап 6: Frontend — Интеграция**
   - Интегрировать RouteMap в RouteDetailsView (F-036)
   - Реализовать переключение альтернативных маршрутов (F-038, F-039)
   - Добавить синхронизацию с списком сегментов (F-041)

**Фаза 5: Testing & Polish (2-3 часа)**
7. После завершения Этапа 6 начать **Этап 7: Тестирование и полировка**
   - Написать критичные тесты (F-054, F-055, F-057)
   - Обработать основные граничные случаи (F-061, F-062, F-063)
   - Провести ручное тестирование
   - Исправить найденные баги

### Следующий шаг в проекте

**Немедленные действия (следующий шаг):**

1. **Начать с Этапа 1: Backend — Инфраструктура**
   - Первая задача: **B-005** — Создать файл `polyline-builder.ts`
   - Вторая задача: **B-009** — Реализовать функцию `buildGreatCirclePolyline`
   - Третья задача: **B-010** — Реализовать функцию `buildStraightPolyline`
   - Четвёртая задача: **B-012** — Реализовать функцию `calculateDistance`

2. **После создания утилит:**
   - Задача **B-006** — Создать файл `BuildRouteMapDataUseCase.ts`
   - Задача **B-001, B-002** — Проектирование структур данных
   - Задача **B-015** — Реализовать цикл обработки сегментов

3. **После реализации Use Case:**
   - Задача **B-007** — Создать файл `RouteMapController.ts`
   - Задача **B-024** — Реализовать endpoint POST `/api/v1/routes/map`
   - Задача **B-025** — Зарегистрировать роут

### Критерии успешного завершения проекта

**Минимально жизнеспособный продукт (MVP):**
- ✅ Backend endpoint `/api/v1/routes/map` возвращает корректные данные
- ✅ Frontend компонент RouteMap отображает маршрут на карте
- ✅ Сегменты отображаются полилиниями с правильными цветами
- ✅ Маркеры start/end/transfer отображаются корректно
- ✅ Карта интегрирована в RouteDetailsView
- ✅ Основные граничные случаи обработаны

**Полная реализация:**
- ✅ Все 7 этапов завершены
- ✅ Покрытие тестами > 80%
- ✅ Все граничные случаи обработаны
- ✅ Оптимизации производительности реализованы
- ✅ E2E тесты написаны и проходят
- ✅ Документация обновлена

### Оценка времени

**Общее время реализации:**
- **Минимум (MVP):** 10-14 часов
  - Backend: 3-4 часа
  - Frontend: 6-8 часов
  - Тестирование: 1-2 часа

- **Полная реализация:** 13-21 час
  - Backend: 4-5 часов
  - Frontend: 8-12 часов
  - Тестирование: 2-3 часа
  - Полировка: 1-2 часа

**Рекомендация:** Начать с MVP, затем постепенно добавлять оптимизации и дополнительные функции.

---

## 6. Чеклист готовности к началу работы

**Перед началом реализации убедитесь, что:**

- [ ] Документ `MAP_Anilize.md` изучен и понят
- [ ] Существующая архитектура проекта понятна
- [ ] Backend структура (Clean Architecture) понятна
- [ ] Frontend структура (Feature-Based) понятна
- [ ] Существующие типы `IBuiltRoute`, `IRouteSegmentDetails` доступны
- [ ] Репозитории `IStopRepository` доступны
- [ ] Утилита `unified-cities-loader` доступна
- [ ] API ключ Yandex Maps получен (для Frontend)
- [ ] Тестовые данные маршрутов подготовлены
- [ ] Git ветка для feature создана

**Готовность к Этапу 1:**
- [ ] Backend проект запускается локально
- [ ] Тесты проходят
- [ ] Структура папок `application/route-builder/use-cases/` существует
- [ ] Структура папок `shared/utils/` существует
- [ ] Структура папок `presentation/controllers/` существует

**Готовность к Этапу 3:**
- [ ] Frontend проект запускается локально
- [ ] Структура папок `modules/routes/features/` существует
- [ ] React Query настроен
- [ ] TypeScript настроен

---

**Документ завершён. Готов к использованию для планирования и реализации.**

**Дата создания:** 2025-01-27  
**Версия:** 1.0  
**Статус:** Готов к реализации