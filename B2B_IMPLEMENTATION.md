# B2B/B2G Implementation

## Обзор

В проект добавлена полноценная B2B/B2G функциональность на основе требований из `b2b2g.md`. Реализация включает в себя:

- **Корпоративные билеты** - управление билетами для сотрудников
- **Капитанская почта** - логистические услуги для доставки грузов
- **AI-аналитика** - интеллектуальные рекомендации и оптимизация расходов
- **Ролевая модель** - гибкая система прав доступа
- **Монетизация** - комиссионная модель 1000-1500₽ за сделку

## Архитектура

### Backend (Clean Architecture)

#### Domain Layer (`/backend/src/domain/entities/`)

**Сущности:**
- `B2BCompany` - компания-клиент с юридическими деталями
- `B2BUser` - пользователи с ролевой моделью (super_admin, company_admin, department_manager, employee, captain)
- `B2BTicket` - корпоративные билеты с категориями и статусами
- `B2BDelivery` - доставки с полным трекингом и характеристиками груза
- `B2BAnalytics` - AI-инсайты и аналитика
- `B2BSubscription` - управление подписками и функциями

#### Application Layer (`/backend/src/application/services/`)

**Сервисы:**
- `B2BCompanyService` - управление компаниями и сотрудниками
- `B2BTicketService` - операции с билетами
- `B2BDeliveryService` - управление доставками с расчетом стоимости
- `B2BAnalyticsService` - AI-аналитика и прогнозирование

#### Presentation Layer (`/backend/src/presentation/`)

**Контроллеры и Middleware:**
- `B2BAuthMiddleware` - аутентификация и авторизация с ролевыми проверками
- `B2BCompanyController` - управление компаниями и сотрудниками
- `B2BTicketController` - CRUD операций с билетами
- `B2BDeliveryController` - управление доставками
- `B2BAnalyticsController` - API для аналитики
- `b2b.ts` - роуты с проверкой прав доступа

### Frontend (Feature-Based Architecture)

#### Modules (`/frontend/src/modules/b2b/`)

**Dashboard:**
- Статистика компании (сотрудники, билеты, доставки, расходы)
- AI-инсайты с рекомендациями по оптимизации
- Лента активности
- Быстрые действия

**Tickets Management:**
- Создание и управление корпоративными билетами
- Фильтрация по статусам, категориям, отделам
- QR-коды для подтвержденных билетов
- Массовые операции

**Deliveries (Капитанская почта):**
- Создание доставок с расчетом стоимости
- Трекинг в реальном времени
- Управление капитанами
- Статусы от ожидания до доставки

### Database (`/backend/src/infrastructure/database/migrations/`)

**Миграции:**
- `005_create_b2b_companies_table.sql` - компании с юридическими данными
- `006_create_b2b_users_table.sql` - пользователи с ролевой иерархией
- `007_create_b2b_tickets_table.sql` - билеты с автоматической генерацией QR
- `008_create_b2b_deliveries_table.sql` - доставки с трекингом
- `009_create_b2b_subscriptions_table.sql` - подписки и платежи

## Ключевые особенности

### 1. Ролевая модель безопасности

```typescript
type B2BUserRole = 'super_admin' | 'company_admin' | 'department_manager' | 'employee' | 'captain';

// Проверки прав в middleware
authMiddleware.authorize(['company_admin', 'department_manager'])
authMiddleware.canManageEmployees()
authMiddleware.canApproveExpenses()
```

### 2. AI-аналитика

- **Предиктивная аналитика цен** - рекомендации оптимальной стоимости
- **Обнаружение аномалий** - выявление нестандартных расходов
- **Оптимизация расходов** - предложения по сокращению затрат
- **Эффективность отделов** - сравнение с бенчмарками

### 3. Капитанская почта

- **Автоматический расчет стоимости** на основе расстояния, веса, срочности
- **Трекинг в реальном времени** с 8 статусами доставки
- **Управление капитанами** с назначением и рейтингом
- **Множественные категории** грузов (документы, посылки, опасные грузы)

### 4. Монетизация

```typescript
// Комиссии за сделки
const DELIVERY_COMMISSION = 1000; // базовая
const EXPRESS_DELIVERY_COMMISSION = 1500; // экспресс
const INSURANCE_COMMISSION = 0.05; // 5% от страховой суммы
```

## API Endpoints

### Компании
```
POST   /api/b2b/companies                    - создание компании
GET    /api/b2b/companies/:id                - информация о компании
PUT    /api/b2b/companies/:id                - обновление данных
GET    /api/b2b/companies/:id/employees      - сотрудники компании
POST   /api/b2b/companies/:id/employees      - добавление сотрудника
```

### Билеты
```
GET    /api/b2b/companies/:id/tickets        - билеты компании
POST   /api/b2b/companies/:id/tickets        - создание билета
POST   /api/b2b/tickets/:id/confirm          - подтверждение билета
POST   /api/b2b/tickets/:id/cancel           - отмена билета
POST   /api/b2b/tickets/bulk                 - массовое создание
```

### Доставки
```
GET    /api/b2b/companies/:id/deliveries     - доставки компании
POST   /api/b2b/companies/:id/deliveries     - создание доставки
POST   /api/b2b/deliveries/:id/confirm       - подтверждение доставки
POST   /api/b2b/deliveries/:id/assign-captain - назначение капитана
POST   /api/b2b/deliveries/calculate-price   - расчет стоимости
```

### Аналитика
```
GET    /api/b2b/companies/:id/analytics          - общая аналитика
GET    /api/b2b/companies/:id/analytics/ai-insights - AI-рекомендации
GET    /api/b2b/companies/:id/analytics/predict-expenses - прогноз расходов
```

## Frontend Компоненты

### Dashboard (`/modules/b2b/features/dashboard/`)
- `b2b-dashboard.tsx` - основная страница дашборда
- `b2b-stats-cards.tsx` - карточки статистики
- `b2b-quick-actions.tsx` - быстрые действия
- `b2b-ai-insights.tsx` - AI-рекомендации
- `b2b-activity-feed.tsx` - лента активности

### Tickets (`/modules/b2b/features/tickets/`)
- `b2b-tickets-page.tsx` - страница управления билетами
- `b2b-tickets-list.tsx` - список билетов с фильтрацией

### Deliveries (`/modules/b2b/features/deliveries/`)
- `b2b-deliveries-page.tsx` - страница управления доставками
- `b2b-deliveries-list.tsx` - список доставок с трекингом

## Бизнес-логика

### 1. Управление билетами
- Автоматическая генерация QR-кодов при подтверждении
- Проверка сроков для отмены (минимум за 24 часа)
- Категоризация: бизнес, тренинги, конференции, тимбилдинг

### 2. Логистика
- Расчет стоимости на основе расстояния, веса, категории
- Автоматическое назначение капитанов при подтверждении
- Прогнозирование времени доставки

### 3. AI-инсайты
- Ежедневный анализ расходов и паттернов
- Рекомендации по оптимизации с оценкой экономии
- Предсказание будущих расходов с учетом сезонности

## Интеграция с основной системой

### 1. Аутентификация
B2B пользователи используют отдельную систему аутентификации с JWT токенами и ролевыми проверками.

### 2. База данных
B2B таблицы используют ту же базу данных PostgreSQL с отдельными миграциями.

### 3. Файловое хранилище
Для фотографий доставок и аватаров пользователей используется существующий MinIO storage.

### 4. Кэширование
Аналитика и статистика кэшируются в Redis для быстрой загрузки дашборда.

## Развитие и масштабирование

### Phase 1 (MVP) - ✅ DONE
- Базовая функциональность билетов и доставок
- Система комиссий и платежей
- Простая аналитика

### Phase 2 (Следующий шаг)
- Мобильное приложение для капитанов
- Интеграция с корпоративными системами (1C, SAP)
- Продвинутые AI-рекомендации
- API для внешних интеграций

### Phase 3 (Будущее)
- Расширение географии услуг
- Дополнительные логистические партнеры
- B2G функции для госконтрактов
- White label решения

## Технические детали

### Performance
- Оптимизированные SQL запросы с proper индексами
- Кэширование аналитики в Redis
- Ленивая загрузка для больших списков

### Security
- Ролевая модель с granular permissions
- Валидация входных данных на всех уровнях
- Rate limiting для API endpoints
- Аудит действий пользователей

### Monitoring
- Логирование всех бизнес-операций
- Метрики использования функций
- Health checks для всех сервисов
- Алерты для аномальной активности

Эта реализация обеспечивает полную функциональность B2B/B2G платформы с возможностью масштабирования и интеграции с существующими системами.